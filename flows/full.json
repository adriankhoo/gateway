[{"id":"18688bee.871194","type":"tab","label":"MAIN Setup","disabled":false,"info":""},{"id":"fb7f9e78.1be6d","type":"tab","label":"StepUpDatabase","disabled":false,"info":""},{"id":"3d881706.03f8d8","type":"tab","label":"Fuka Periodic Pool","disabled":false,"info":""},{"id":"817f9d68.8209b","type":"tab","label":"Data logger","disabled":false,"info":""},{"id":"2dea478e.0b12e8","type":"tab","label":"SaveToCSV","disabled":false,"info":""},{"id":"f1077768.4a5678","type":"tab","label":"SaveToFirebase","disabled":false,"info":""},{"id":"8e3b6373.cc438","type":"tab","label":"StepUpDatabase","disabled":false,"info":""},{"id":"a64a8867.86c548","type":"tab","label":"AdminAPI","disabled":false,"info":""},{"id":"38d95549.1ac3fa","type":"tab","label":"ConfigurationFile","disabled":false,"info":""},{"id":"42ab3f6e.5db45","type":"modbus-client","name":"Sunful HMI","clienttype":"tcp","bufferCommands":true,"stateLogEnabled":false,"queueLogEnabled":false,"tcpHost":"127.0.0.1","tcpPort":"8502","tcpType":"DEFAULT","serialPort":"/dev/ttyUSB","serialType":"RTU-BUFFERD","serialBaudrate":"9600","serialDatabits":"8","serialStopbits":"1","serialParity":"none","serialConnectionDelay":"100","unit_id":1,"commandDelay":3,"clientTimeout":900,"reconnectOnTimeout":true,"reconnectTimeout":1500,"parallelUnitIdsAllowed":true},{"id":"cd838d7e.a8bb3","type":"sqlitedb","db":"C:\\Users\\adriank\\Downloads\\fuka.db","mode":"RWC"},{"id":"89074b3.f4c85b8","type":"modbus-io-config","name":"MyIOFile","path":"C:\\Users\\adriank\\Downloads\\dbsettings","format":"utf8","addressOffset":""},{"id":"aae23db.bb554c","type":"sqlite","z":"fb7f9e78.1be6d","mydb":"cd838d7e.a8bb3","sqlquery":"msg.topic","sql":"","name":"Fuka.DB","x":580,"y":200,"wires":[[]]},{"id":"a089f9cb.99ca88","type":"inject","z":"fb7f9e78.1be6d","name":"Create RT Table","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"CREATE TABLE REALTIME(TIMESTAMP INT PRIMARY KEY NOT NULL, VALUE INT NOT NULL, BOOL INT NOT NULL)","payload":"","payloadType":"date","x":360,"y":160,"wires":[["aae23db.bb554c"]]},{"id":"74fbca0e.b9cdc4","type":"inject","z":"fb7f9e78.1be6d","name":"Create Daily Table","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"CREATE TABLE DAILY(TIMESTAMP INT PRIMARY KEY NOT NULL, VALUE INT NOT NULL, BOOL INT NOT NULL)","payload":"","payloadType":"date","x":370,"y":240,"wires":[["aae23db.bb554c"]]},{"id":"2e35be52.55eec2","type":"inject","z":"3d881706.03f8d8","d":true,"name":"Periodic pool","props":[{"p":"payload"},{"p":"topic","v":"{\"ip\":\"localhost\",\"port\":502,\"start\":0,\"end\":13}","vt":"json"}],"repeat":"1","crontab":"","once":true,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":130,"y":100,"wires":[["3bffdac4.7a4076"]]},{"id":"3bffdac4.7a4076","type":"modbus-getter","z":"3d881706.03f8d8","name":"Read Data points","showStatusActivities":false,"showErrors":false,"logIOActivities":true,"unitid":"1","dataType":"HoldingRegister","adr":"0","quantity":"20","server":"42ab3f6e.5db45","useIOFile":false,"ioFile":"89074b3.f4c85b8","useIOForPayload":true,"emptyMsgOnFail":false,"keepMsgProperties":false,"x":360,"y":100,"wires":[["71738dd6.3da664"],[]]},{"id":"71738dd6.3da664","type":"debug","z":"3d881706.03f8d8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":670,"y":60,"wires":[]},{"id":"34224dfb.ddee22","type":"status","z":"fb7f9e78.1be6d","name":"Node","scope":null,"x":350,"y":360,"wires":[["e53a70ff.369e6"]]},{"id":"e53a70ff.369e6","type":"debug","z":"fb7f9e78.1be6d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"status","targetType":"msg","statusVal":"","statusType":"auto","x":550,"y":360,"wires":[]},{"id":"448ad112.eaa8a","type":"inject","z":"817f9d68.8209b","name":"DummyModbusData","props":[{"p":"timestamp","v":"","vt":"date"},{"p":"topic","vt":"str"},{"p":"payload"},{"p":"start","v":"0","vt":"num"},{"p":"end","v":"15","vt":"str"},{"p":"conversion","v":"word","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"1","topic":"HMI","payload":"096d1ac00984004811af08e30d1c09fd00420b66099c1148097b004905630000","payloadType":"str","x":130,"y":20,"wires":[["81037edf.777e2"]]},{"id":"8b3f7e47.4893d","type":"function","z":"817f9d68.8209b","name":"Payload-Chunk and Bytes conversion","func":"// Convert a hex string to a byte array\nfunction hexToBytesInt(hex) {\n    let bytes = [];\n    for (let c = 0; c < hex.length; c += 2)\n        bytes.push(parseInt(hex.substr(c, 2), 16));\n    return bytes;\n}\n\nconst dataTypeMap = new Map();\ndataTypeMap.set(\"long\", 8)\ndataTypeMap.set(\"word\", 4)\ndataTypeMap.set(\"byte\", 2)\ndataTypeMap.set(\"boolean\", 1)\n\nconst { conversion, payload } = msg\nif (!dataTypeMap.has(conversion)) {\n    return {}\n}\n\nconst chunkSize = dataTypeMap.get(conversion);\nvar chunks = payload.match(new RegExp('.{1,' + chunkSize + '}', 'g'));\n\nmsg.payload = chunks.map(hexToBytesInt);\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":270,"y":140,"wires":[["d3e72d6a.f150f"]]},{"id":"d3e72d6a.f150f","type":"function","z":"817f9d68.8209b","name":"Configuration-Data Points","func":"msg.data = msg.payload;\nmsg.payload = [\n    {name: \"Power 1\", descriptions: \"Power 1 at main\", unit:\"KW\", multiplier:10, position:0},\n    {name: \"Power 2\", descriptions: \"Power 2 at main\", unit:\"KW\", multiplier:10, position:1},\n    {name: \"Power 3\", descriptions: \"Power 3 at main\", unit:\"KW\", multiplier:10, position:2},\n    {name: \"Voltage 1\", descriptions: \"Voltage 1\", unit:\"V\", multiplier:10, position:3},\n    {name: \"Voltage 2\", descriptions: \"Voltage 2\", unit:\"V\", multiplier:10, position:4},\n    {name: \"Voltage 3\", descriptions: \"Voltage 3\", unit:\"V\", multiplier:10, position:5},\n    {name: \"Current 1\", descriptions: \"Current 1\", unit:\"A\", multiplier:10, position:6},\n    {name: \"Current 2\", descriptions: \"Current 2\", unit:\"A\", multiplier:10, position:7},\n    {name: \"Current 3\", descriptions: \"Current 3\", unit:\"A\", multiplier:10, position:8},];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":230,"y":200,"wires":[["7334553c.c64f1c"]],"icon":"font-awesome/fa-address-book-o"},{"id":"16988e52.73e832","type":"function","z":"817f9d68.8209b","name":"Data bytes converter","func":"function bytesToUint16(dataArray, isLE, offset){\n    if (dataArray.length < 2 * (offset + 1)) {\n        return \"Invalid [dataArray] size!\";\n    }\n\n    const buf = Buffer.from(dataArray);\n    return isLE ? buf.readUInt16LE(offset) : buf.readUInt16BE(offset);\n}\n\nfunction bytesToInt16(dataArray, isLE, offset){\n    if (dataArray.length < 2 * (offset + 1)) {\n        return \"Invalid [dataArray] size!\";\n    }\n\n    const buf = Buffer.from(dataArray);\n    return isLE ? buf.readInt16LE(offset) : buf.readInt16BE(offset);\n}\n\nfunction bytesToUint32(dataArray, isLE, offset){\n    if (dataArray.length < 4 * (offset + 1)) {\n        return \"Invalid [dataArray] size!\";\n    }\n\n    const buf = Buffer.from(dataArray);\n    return isLE ? buf.readUInt32LE(offset).toString(16) : buf.readUInt32BE(offset).toString(16);\n}\n\nfunction bytesToInt32(dataArray, isLE, offset){\n    if (dataArray.length < 4 * (offset + 1)) {\n        return \"Invalid [dataArray] size!\";\n    }\n\n    const buf = Buffer.from(dataArray);\n    return isLE ? buf.readInt32LE(offset).toString(16) : buf.readInt32BE(offset).toString(16);\n}\n\nfunction bytesToFloat(dataArray, isLE, offset){\n    if (dataArray.length < 4 * (offset + 1)) {\n        return \"Invalid [dataArray] size!\";\n    }\n\n    const buf = Buffer.from(dataArray);\n    return isLE ? buf.readFloatLE(offset) : buf.readFloatBE(offset);\n}\n\nfunction bytesToDouble(dataArray, isLE, offset) {\n    if (dataArray.length < 8  * (offset + 1)) {\n        return \"Invalid [dataArray] size!\";\n    }\n\n    const buf = Buffer.from(dataArray);\n    return isLE ? buf.readDoubleLE(offset) : buf.readDoubleBE(offset);\n}\n\nconst typeConverter = new Map();\ntypeConverter.set(\"word\", bytesToInt16)\ntypeConverter.set(\"uint16\", bytesToUint16)\ntypeConverter.set(\"int32\", bytesToInt32)\ntypeConverter.set(\"uint32\", bytesToUint32)\ntypeConverter.set(\"float\", bytesToFloat)\ntypeConverter.set(\"double\", bytesToDouble)\n\nconst { payload, conversion } = msg;\nif (!typeConverter.has(conversion)) {\n    return {};\n}\n\nlet converter = typeConverter.get(conversion);\npayload.reading = converter(payload.inBytes, false);\npayload.plain = payload.reading/payload.multiplier;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":220,"y":380,"wires":[["84a61452.b425d8"]]},{"id":"fbb06c7d.a3ab8","type":"function","z":"817f9d68.8209b","name":"Payload-Filters by Data Points","func":"const { data, timestamp, ticks, payload } = msg;\npayload.inBytes = data[payload.position];\npayload.timestamp = timestamp;\npayload.ticks = ticks;\n\nmsg.payload = payload;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":250,"y":320,"wires":[["16988e52.73e832"]]},{"id":"7334553c.c64f1c","type":"split","z":"817f9d68.8209b","name":"Split by configs","splt":"","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":160,"y":260,"wires":[["fbb06c7d.a3ab8"]]},{"id":"81037edf.777e2","type":"function","z":"817f9d68.8209b","name":"Add timestamp and ticks","func":"const dt = new Date();\nmsg.timestamp = dt;\nmsg.ticks = dt.getTime();\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":230,"y":80,"wires":[["8b3f7e47.4893d"]]},{"id":"84a61452.b425d8","type":"function","z":"817f9d68.8209b","name":"Add end ticks","func":"const dt = new Date();\nmsg.payload.endTicks = dt.getTime() - msg.payload.ticks;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":200,"y":440,"wires":[["7e76b939.1f31b8","3e72eaa2.ffbf16"]]},{"id":"22e6ece0.1c70f4","type":"file","z":"817f9d68.8209b","name":"","filename":"","appendNewline":true,"createDir":true,"overwriteFile":"true","encoding":"utf8","x":790,"y":500,"wires":[[]]},{"id":"e6e4174.95492e8","type":"json","z":"817f9d68.8209b","name":"Final result as Json","property":"payload","action":"str","pretty":false,"x":610,"y":500,"wires":[["22e6ece0.1c70f4"]]},{"id":"7e76b939.1f31b8","type":"function","z":"817f9d68.8209b","name":"Set filename","func":"var folderName = \"C:\\\\Users\\\\adriank\\\\Downloads\\\\iiot\\\\\";\nmsg.filename =folderName+msg.payload.name+'.json'\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":410,"y":500,"wires":[["e6e4174.95492e8"]]},{"id":"2a7cea00.dcfca6","type":"link out","z":"817f9d68.8209b","name":"ProcessedDatapoints(DataLogger)","links":["9e1746e4.639478","6fd93abb.a69e44","3a0a9148.631e3e","e7cebc70.f7d0a","17a2ee22.8d1812"],"x":535,"y":440,"wires":[]},{"id":"3e72eaa2.ffbf16","type":"function","z":"817f9d68.8209b","name":"Pre-sanitize","func":"var { plain, name, unit } = msg.payload;\n\nmsg.payload = {\n    key : `${name} (${unit})`,\n    value : plain\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":410,"y":440,"wires":[["2a7cea00.dcfca6"]]},{"id":"e7cebc70.f7d0a","type":"link in","z":"f1077768.4a5678","name":"","links":["2a7cea00.dcfca6"],"x":55,"y":60,"wires":[["f678dea5.a288d"]]},{"id":"f678dea5.a288d","type":"join","z":"f1077768.4a5678","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":150,"y":60,"wires":[["28c73273.b9e94e","9139a938.8bc6a8"]]},{"id":"28c73273.b9e94e","type":"debug","z":"f1077768.4a5678","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":350,"y":60,"wires":[]},{"id":"25f01df7.794cc2","type":"http request","z":"f1077768.4a5678","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":550,"y":120,"wires":[[]]},{"id":"9139a938.8bc6a8","type":"function","z":"f1077768.4a5678","name":"RTDB PUT","func":"var authkey = 'AYMgafmbudBz32x2Ji8JWMtipjp1lmKZC5B8opN9';\nvar deployId = '14364541c65441623544c4'\n\nvar { ticks, timestamp, payload } = msg;\nvar request = {\n    url : `https://fillmehere.firebaseio.com/full/realtime/${deployId}.json?auth=${authkey}`,\n    method : 'PUT',\n    payload : {\n        ticks,\n        timestamp,\n        values : payload\n    },\n    rejectUnauthorized : false ,\n    requestTimeout : 900\n}\n\nreturn request;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":120,"wires":[["25f01df7.794cc2"]]},{"id":"17a2ee22.8d1812","type":"link in","z":"2dea478e.0b12e8","name":"","links":["2a7cea00.dcfca6"],"x":55,"y":60,"wires":[["aeeb2c70.1e887"]]},{"id":"aeeb2c70.1e887","type":"join","z":"2dea478e.0b12e8","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":150,"y":60,"wires":[["f9845255.13ce8"]]},{"id":"15a66f5a.ca3cc1","type":"csv","z":"2dea478e.0b12e8","name":"","sep":",","hdrin":false,"hdrout":"once","multi":"one","ret":"\\n","temp":"","skip":"0","strings":true,"include_empty_strings":true,"include_null_values":true,"x":290,"y":120,"wires":[["5c52d8d0.856768","9d6fbe4c.a7d1f"]]},{"id":"9d6fbe4c.a7d1f","type":"debug","z":"2dea478e.0b12e8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"timestamp","targetType":"msg","statusVal":"","statusType":"auto","x":460,"y":120,"wires":[]},{"id":"5c52d8d0.856768","type":"file","z":"2dea478e.0b12e8","name":"","filename":"C:\\Users\\adriank\\Downloads\\iiot\\timestamp.csv","appendNewline":false,"createDir":false,"overwriteFile":"false","encoding":"none","x":560,"y":180,"wires":[[]]},{"id":"f9845255.13ce8","type":"function","z":"2dea478e.0b12e8","name":"Convert Key to Properties","func":"const { ticks, timestamp, payload } = msg;\nmsg.payload = {\n    ticks,\n    timestamp : timestamp.toISOString()\n}\n\nfunction merge({key, value}){\n    msg.payload[key] = value;   \n}\n\npayload.forEach(merge);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":60,"wires":[["15a66f5a.ca3cc1"]]},{"id":"edc99691.f006a8","type":"http request","z":"18688bee.871194","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":630,"y":40,"wires":[["857acd54.f0f69","e7be84a0.d54a18"]]},{"id":"130c20a9.8e2eef","type":"function","z":"18688bee.871194","name":"EXTERNAL GET","func":"const url = msg.headers.url ? \n    msg.headers.url : \n    'https://raw.githubusercontent.com/fukatechnologies/gateway/master/flows/full.json';\n\nreturn {\n    url,\n    method : 'GET',\n    headers : { 'Content-Type' : 'application/json' },\n    rejectUnauthorized : false ,\n    requestTimeout : 2000\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","x":430,"y":40,"wires":[["edc99691.f006a8"]]},{"id":"b731e41d.99eea8","type":"function","z":"18688bee.871194","name":"POST FULL FLOW","func":"const { payload } = msg;\nreturn {\n    payload,\n    url : `http://localhost:1880/flows/`,\n    method : 'POST',\n    headers : { 'Content-Type' : 'application/json', 'Node-RED-Deployment-Type' : 'full' },\n    requestTimeout : 1000\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","x":430,"y":160,"wires":[["98700679.02b1e8"]]},{"id":"98700679.02b1e8","type":"http request","z":"18688bee.871194","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":630,"y":160,"wires":[["e7be84a0.d54a18"]]},{"id":"857acd54.f0f69","type":"json","z":"18688bee.871194","name":"","property":"payload","action":"","pretty":false,"x":350,"y":100,"wires":[["b731e41d.99eea8"]]},{"id":"329a965f.ee0d0a","type":"http in","z":"18688bee.871194","name":"","url":"/installworkflow","method":"get","upload":false,"swaggerDoc":"","x":130,"y":40,"wires":[["130c20a9.8e2eef"]]},{"id":"e7be84a0.d54a18","type":"http response","z":"18688bee.871194","name":"OK","statusCode":"200","headers":{},"x":850,"y":40,"wires":[]},{"id":"93b552b0.3ad02","type":"http in","z":"18688bee.871194","name":"","url":"/installworkflow","method":"post","upload":false,"swaggerDoc":"","x":140,"y":160,"wires":[["b731e41d.99eea8"]]},{"id":"4df9aba7.8679e4","type":"sqlite","z":"8e3b6373.cc438","mydb":"cd838d7e.a8bb3","sqlquery":"msg.topic","sql":"","name":"Fuka.DB","x":580,"y":200,"wires":[[]]},{"id":"f90e5d18.64248","type":"inject","z":"8e3b6373.cc438","name":"Create RT Table","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"CREATE TABLE REALTIME(TIMESTAMP INT PRIMARY KEY NOT NULL, VALUE INT NOT NULL, BOOL INT NOT NULL)","payload":"","payloadType":"date","x":360,"y":160,"wires":[["4df9aba7.8679e4"]]},{"id":"26a0f925.880ab6","type":"inject","z":"8e3b6373.cc438","name":"Create Daily Table","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"CREATE TABLE DAILY(TIMESTAMP INT PRIMARY KEY NOT NULL, VALUE INT NOT NULL, BOOL INT NOT NULL)","payload":"","payloadType":"date","x":370,"y":240,"wires":[["4df9aba7.8679e4"]]},{"id":"8e50757b.3bdd28","type":"status","z":"8e3b6373.cc438","name":"Node","scope":null,"x":350,"y":360,"wires":[["21a7492a.6624a6"]]},{"id":"21a7492a.6624a6","type":"debug","z":"8e3b6373.cc438","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"status","targetType":"msg","statusVal":"","statusType":"auto","x":550,"y":360,"wires":[]},{"id":"8bc4c986.1650d8","type":"http in","z":"a64a8867.86c548","name":"","url":"/admin","method":"get","upload":false,"swaggerDoc":"","x":170,"y":100,"wires":[["9c95434f.cd21f"]]},{"id":"ec989b6b.2b5d28","type":"http response","z":"a64a8867.86c548","name":"200 OK","statusCode":"200","headers":{},"x":1600,"y":225,"wires":[]},{"id":"1e2dcce.7b98833","type":"switch","z":"a64a8867.86c548","name":"Authenticate","property":"req.headers.token","propertyType":"msg","rules":[{"t":"neq","v":"payload.adminToken","vt":"msg"},{"t":"eq","v":"payload.adminToken","vt":"msg"}],"checkall":"true","repair":false,"outputs":2,"x":250,"y":220,"wires":[["23836bbb.1acb14"],["c0bcc337.d2ad8"]]},{"id":"6555ab10.f9de64","type":"http response","z":"a64a8867.86c548","name":"403 Forbidden","statusCode":"403","headers":{},"x":680,"y":180,"wires":[]},{"id":"3e20f0b5.f1496","type":"switch","z":"a64a8867.86c548","name":"Validate API Type","property":"adminPayload.type","propertyType":"msg","rules":[{"t":"eq","v":"settings","vt":"str"},{"t":"eq","v":"backupflow","vt":"str"},{"t":"eq","v":"restoreflow","vt":"str"},{"t":"eq","v":"url","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":5,"x":690,"y":260,"wires":[["ec989b6b.2b5d28"],["89fd916c.3de98"],["95f55969.ecf3d8"],["a6ade7e4.fe30f8"],["496d02dc.3a5c8c"]]},{"id":"c0bcc337.d2ad8","type":"function","z":"a64a8867.86c548","name":"Remove adminToken","func":"delete msg.payload.adminToken;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":460,"y":260,"wires":[["3e20f0b5.f1496"]]},{"id":"23836bbb.1acb14","type":"function","z":"a64a8867.86c548","name":"Add Error","func":"msg.payload = msg.adminPayload;\nmsg.payload.error = 'Unauthorized';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":420,"y":180,"wires":[["6555ab10.f9de64"]]},{"id":"a6ade7e4.fe30f8","type":"switch","z":"a64a8867.86c548","name":"Contains URL","property":"adminPayload.url","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":780,"y":485,"wires":[["d31c336.81cebd"],["792aeb0e.cfc394"]]},{"id":"496d02dc.3a5c8c","type":"function","z":"a64a8867.86c548","name":"Add Error","func":"msg.payload = {\n    error : 'Unsupported API'\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":980,"y":405,"wires":[["de9b0a62.d89648"]]},{"id":"de9b0a62.d89648","type":"http response","z":"a64a8867.86c548","name":"404 Not Found","statusCode":"404","headers":{},"x":1180,"y":425,"wires":[]},{"id":"d31c336.81cebd","type":"function","z":"a64a8867.86c548","name":"Add Error","func":"msg.payload = {\n    error : 'Requires a valid URL'\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":980,"y":465,"wires":[["de9b0a62.d89648"]]},{"id":"f33f2041.37c26","type":"http request","z":"a64a8867.86c548","name":"Get flow","method":"use","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":980,"y":545,"wires":[["aa783241.31"]]},{"id":"792aeb0e.cfc394","type":"function","z":"a64a8867.86c548","name":"EXTERNAL GET","func":"return {\n    url : msg.adminPayload.url,\n    method : 'GET',\n    headers : { 'Content-Type' : 'application/json' },\n    rejectUnauthorized : false,\n    requestTimeout : 5000\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","x":790,"y":545,"wires":[["f33f2041.37c26"]]},{"id":"aa783241.31","type":"function","z":"a64a8867.86c548","name":"POST FULL FLOW","func":"const { payload } = msg;\nreturn {\n    payload,\n    url : `http://localhost:1880/flows/`,\n    method : 'POST',\n    headers : { \n        'Content-Type' : 'application/json', \n        'Node-RED-Deployment-Type' : 'full' \n    },\n    requestTimeout : 1000\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1190,"y":545,"wires":[["3bf4121d.65a38e"]]},{"id":"96664e8a.d3963","type":"inject","z":"a64a8867.86c548","name":"Test Deploy WF","props":[{"p":"payload"},{"p":"adminPayload.url1","v":"https://raw.githubusercontent.com/fukatechnologies/gateway/master/flows/firstrun.json","vt":"str"},{"p":"adminPayload.url","v":"http://localhost:1880/flows","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":220,"y":540,"wires":[["792aeb0e.cfc394"]]},{"id":"89fd916c.3de98","type":"http request","z":"a64a8867.86c548","name":"backupflow","method":"GET","ret":"obj","paytoqs":"ignore","url":"http://localhost:1880/flows","tls":"","persist":false,"proxy":"","authType":"","x":990,"y":285,"wires":[["2f64ec62.cf13e4"]]},{"id":"2f64ec62.cf13e4","type":"file","z":"a64a8867.86c548","name":"","filename":"fukaFlow.json.backup","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":1200,"y":285,"wires":[["ec989b6b.2b5d28"]]},{"id":"1ac02f79.974231","type":"file in","z":"a64a8867.86c548","name":"","filename":"fukaFlow.json.backup","format":"","chunk":false,"sendError":false,"encoding":"none","x":1200,"y":345,"wires":[["3bf4121d.65a38e"]]},{"id":"3bf4121d.65a38e","type":"http request","z":"a64a8867.86c548","name":"","method":"use","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1410,"y":345,"wires":[["ec989b6b.2b5d28"]]},{"id":"95f55969.ecf3d8","type":"function","z":"a64a8867.86c548","name":"Restore flow","func":"return {\n    url : `http://localhost:1880/flows/`,\n    method : 'POST',\n    headers : { \n        'Content-Type' : 'application/json', \n        'Node-RED-Deployment-Type' : 'full' \n    },\n    requestTimeout : 1000\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","x":990,"y":345,"wires":[["1ac02f79.974231"]]},{"id":"aed4dc01.fcabc","type":"debug","z":"a64a8867.86c548","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":250,"y":300,"wires":[]},{"id":"9c95434f.cd21f","type":"function","z":"a64a8867.86c548","name":"As adminPayload","func":"msg.adminPayload = msg.payload;\nmsg.adminPayload.url = msg.req.headers.url;\nmsg.topic = 'AdminAPI.getSettings';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":450,"y":100,"wires":[["1434a7f.02e3858"]]},{"id":"e00c67a4.bbb768","type":"link out","z":"38d95549.1ac3fa","name":"AdminAPI.getSettings","links":["b4bd361b.b00f68"],"x":1255,"y":120,"wires":[]},{"id":"9e29cbc5.c378e8","type":"file in","z":"38d95549.1ac3fa","name":"Get FukaSettings.json","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":800,"y":140,"wires":[["a4c94fb6.34f07"]]},{"id":"a4c94fb6.34f07","type":"json","z":"38d95549.1ac3fa","name":"To Json","property":"payload","action":"obj","pretty":false,"x":1000,"y":140,"wires":[["f95f5899.499cf8"]]},{"id":"b03b3716.072138","type":"inject","z":"38d95549.1ac3fa","name":"Save","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"saveSettings","payload":"","payloadType":"date","x":130,"y":100,"wires":[["6467b811.d64108"]]},{"id":"daa71b9c.d02bb8","type":"file","z":"38d95549.1ac3fa","name":"Save settings","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":1060,"y":60,"wires":[[]]},{"id":"b65dc1b9.cd52d","type":"link in","z":"38d95549.1ac3fa","name":"ConfigurationFile.getSettings","links":["1434a7f.02e3858"],"x":155,"y":160,"wires":[["6467b811.d64108"]]},{"id":"6467b811.d64108","type":"function","z":"38d95549.1ac3fa","name":"FukaSettings.json file path","func":"msg.filename = 'FukaSettings.json';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":340,"y":100,"wires":[["860d00a8.e813"]]},{"id":"860d00a8.e813","type":"switch","z":"38d95549.1ac3fa","name":"execute by topic","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"saveSettings","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":580,"y":100,"wires":[["b84c46b4.94d1e8"],["9e29cbc5.c378e8"]]},{"id":"b84c46b4.94d1e8","type":"function","z":"38d95549.1ac3fa","name":"Configure FukaSettings.json","func":"msg.payload = {\n    adminToken : 'HelloWorld123.',\n    deploymentId : '-',\n    workflowUrl : '-',\n    commandListenerUrl : '-'\n};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":820,"y":60,"wires":[["daa71b9c.d02bb8"]]},{"id":"1434a7f.02e3858","type":"link out","z":"a64a8867.86c548","name":"","links":["b65dc1b9.cd52d"],"x":615,"y":100,"wires":[]},{"id":"b4bd361b.b00f68","type":"link in","z":"a64a8867.86c548","name":"","links":["e00c67a4.bbb768"],"x":115,"y":260,"wires":[["aed4dc01.fcabc","1e2dcce.7b98833"]]},{"id":"f95f5899.499cf8","type":"switch","z":"38d95549.1ac3fa","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"AdminAPI.getSettings","vt":"str"},{"t":"eq","v":"Updater.getSettings","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1150,"y":140,"wires":[["e00c67a4.bbb768"],["74012874.52bf48"]]},{"id":"74012874.52bf48","type":"link out","z":"38d95549.1ac3fa","name":"Updater.getSettings","links":[],"x":1255,"y":160,"wires":[]}]
